window.digiriskdolibarr||(window.digiriskdolibarr={},window.digiriskdolibarr.scriptsLoaded=!1),window.digiriskdolibarr.scriptsLoaded||(window.digiriskdolibarr.init=function(){window.digiriskdolibarr.load_list_script()},window.digiriskdolibarr.load_list_script=function(){if(!window.digiriskdolibarr.scriptsLoaded){var i=void 0,e=void 0;for(i in window.digiriskdolibarr)for(e in window.digiriskdolibarr[i].init&&window.digiriskdolibarr[i].init(),window.digiriskdolibarr[i])window.digiriskdolibarr[i]&&window.digiriskdolibarr[i][e]&&window.digiriskdolibarr[i][e].init&&window.digiriskdolibarr[i][e].init();window.digiriskdolibarr.scriptsLoaded=!0}},window.digiriskdolibarr.refresh=function(){var i=void 0,e=void 0;for(i in window.digiriskdolibarr)for(e in window.digiriskdolibarr[i].refresh&&window.digiriskdolibarr[i].refresh(),window.digiriskdolibarr[i])window.digiriskdolibarr[i]&&window.digiriskdolibarr[i][e]&&window.digiriskdolibarr[i][e].refresh&&window.digiriskdolibarr[i][e].refresh()},$(document).ready(window.digiriskdolibarr.init)),window.digiriskdolibarr.accident={},window.digiriskdolibarr.accident.init=function(){window.digiriskdolibarr.accident.event()},window.digiriskdolibarr.accident.event=function(){$(document).on("submit",".sendfile",window.digiriskdolibarr.accident.tmpStockFile),$(document).on("click",".linked-file-delete-workstop",window.digiriskdolibarr.accident.removeFile),$(document).on("change","#external_accident",window.digiriskdolibarr.accident.showExternalAccidentLocation)},window.digiriskdolibarr.accident.tmpStockFile=function(e,i=""){var s=$("#sendfile").prop("files"),t=new FormData;for(let i=0;i<s.length;i++){var a=s[i];t.append("files[]",a)}var n=window.saturne.toolbox.getToken(),i=0<i.length?"&subaction="+i:"";$.ajax({url:document.URL+"&action=sendfile&objectlineid="+e+"&token="+n+i,type:"POST",processData:!1,contentType:!1,data:t,success:function(i){$("#sendFileForm"+e).html($(i).find("#fileLinkedTable"+e))},error:function(){}})},window.digiriskdolibarr.accident.removeFile=function(i){let e=$(this).attr("value");var s=$(this).hasClass("edit-line")?"&subaction=editline":"";e=e.replace("_mini","");let t=$(this).closest(".objectline").attr("value");var a=window.saturne.toolbox.getToken();$.ajax({url:document.URL+"&action=removefile&filetodelete="+e+"&objectlineid="+t+"&token="+a+s,type:"POST",processData:!1,contentType:!1,success:function(i){$("#sendFileForm"+t).html($(i).find("#fileLinkedTable"+t))},error:function(){}})},window.digiriskdolibarr.accident.showExternalAccidentLocation=function(){var i=$(this).closest(".accident-table").find(".fk_element_field"),e=$(this).closest(".accident-table").find(".fk_soc_field"),s=$(this).closest(".accident-table").find(".accident_location_field");switch($(this).closest(".accident-table").find("#select2-external_accident-container").attr("title")){case"Non":i.attr("style",""),e.attr("style","display:none"),s.attr("style","display:none"),i.removeClass("hidden"),e.addClass("hidden"),s.addClass("hidden");break;case"Oui":i.attr("style","display:none"),e.attr("style",""),s.attr("style","display:none"),i.addClass("hidden"),e.removeClass("hidden"),s.addClass("hidden");break;case"Autre":i.attr("style","display:none"),e.attr("style","display:none"),s.attr("style",""),i.addClass("hidden"),e.addClass("hidden"),s.removeClass("hidden")}},window.digiriskdolibarr.admin={},window.digiriskdolibarr.admin.urlSuffix="-ticket-public-interface-url",window.digiriskdolibarr.admin.optionKeys=["origin-current","short-current","external-current","origin-multicompany","short-multicompany","external-multicompany"],window.digiriskdolibarr.admin.mappings=window.digiriskdolibarr.admin.optionKeys.map(i=>({radio:"#"+i+window.digiriskdolibarr.admin.urlSuffix,label:`#${i}${window.digiriskdolibarr.admin.urlSuffix}-label`,input:`#${i}${window.digiriskdolibarr.admin.urlSuffix}-input`})),window.digiriskdolibarr.admin.init=function(){window.digiriskdolibarr.admin.initRadioLogicTicketPublicInterface()},window.digiriskdolibarr.admin.initRadioLogicTicketPublicInterface=function(){window.digiriskdolibarr.admin.mappings.forEach(({radio:i,label:e,input:s})=>{$(document).on("click",e,()=>{$(i).prop("checked",!0),s&&$(s).focus()}),s&&$(document).on("focus",s,()=>{$(i).prop("checked",!0)})})},window.digiriskdolibarr.digiai={},window.digiriskdolibarr.digiai.init=function(){window.digiriskdolibarr.digiai.event(),window.digiriskdolibarr.digiai.initTabs()},window.digiriskdolibarr.digiai.event=function(){$(document).on("submit","#analyze_text_form",window.digiriskdolibarr.digiai.submitTextForm),$(document).on("click",".digiAI-tab-button",window.digiriskdolibarr.digiai.switchTab),$(document).on("click",".open-analyze-image-modal",window.digiriskdolibarr.digiai.changeModalButton),$(document).on("click",".analyze-image",window.digiriskdolibarr.digiai.submitImageForm),$(document).on("click",".clickable-photo",window.digiriskdolibarr.digiai.selectPhoto)},window.digiriskdolibarr.digiai.initTabs=function(){$(".digiAI-tab-button").first().addClass("active"),$(".digiAI-tab-content").first().addClass("active")},window.digiriskdolibarr.digiai.switchTab=function(i){i.preventDefault();i=$(this).attr("data-tab");$(".digiAI-tab-button").removeClass("active"),$(".digiAI-tab-content").removeClass("active"),$(this).addClass("active"),$("#"+i).addClass("active")},window.digiriskdolibarr.digiai.selectPhoto=function(i){$(".analyze-image").removeClass("button-disable")},window.digiriskdolibarr.digiai.changeModalButton=function(){$('.modal-photo[data-from-type="digiAi"]').find(".save-photo").removeClass("save-photo").addClass("analyze-image")},window.digiriskdolibarr.digiai.submitImageForm=async function(i){i.preventDefault(),window.digiriskdolibarr.digiai.resetModal("image");var i=$("#media_gallery"),e=$(this).closest(".modal-container"),i=(i.removeClass("modal-active"),e.find(".clicked-photo").first().find(".filename").val()),e=e.find(".clicked-photo").first().find("img").attr("src");if(i){$("#uploaded-image-preview").attr("src",e).css("opacity",1).show(),$("#analyzed-text-preview").hide(),$(".analysis-in-progress").show().css("opacity",1),$(".analysis-result").hide(),$("#digiai_modal").addClass("modal-active");try{var s=await fetch(e);if(!s.ok)throw new Error("HTTP error! status: "+s.status);var t=await s.blob(),a=new FormData;a.append("image_file",t,i),a.append("action","analyze_image"),window.digiriskdolibarr.digiai.getChatGptResponse(a)}catch(i){console.error("Erreur lors du chargement de l'image:",i),alert("Erreur lors du chargement de l'image depuis la bibliothèque de médias"),$("#digiai_modal").removeClass("modal-active")}}else alert("Veuillez sélectionner une image.")},window.digiriskdolibarr.digiai.submitTextForm=async function(i){i.preventDefault();var e,i=$("#analysis_text").val().trim();i?(window.digiriskdolibarr.digiai.resetModal("text"),$("#uploaded-image-preview").hide(),$("#analyzed-text-preview").show(),$(".text-preview-content").html(i.replace(/\n/g,"<br>")),$(".digiai-loader-text").text("Analyse en cours du texte..."),$("#digiai_modal").addClass("modal-active"),(e=new FormData).append("action","analyze_text"),e.append("analysis_text",i),window.digiriskdolibarr.digiai.getChatGptResponse(e)):alert("Veuillez saisir du texte à analyser")},window.digiriskdolibarr.digiai.getChatGptResponse=async function(i){var e=window.saturne.toolbox.getToken();try{var s=await fetch("backend_endpoint_for_chatgpt.php?token="+e,{method:"POST",body:i});if(!s.ok)throw new Error('Pas de clé API ou de jetons suffisants, veuillez configurer votre clé API dans "Configuration => DigiAI"');var t=await s.json();if(t.error)throw new Error('Pas de clé API ou de jetons suffisants, veuillez configurer votre clé API dans "Configuration => DigiAI"');var a=t.choices[0].message.content.trim().replace(/^```json\s*|```$/g,"").trim();try{JSON.parse(a)}catch(i){throw new Error("Erreur lors de l'analyse de l'image, veuillez réessayer")}var n=JSON.parse(a);window.digiriskdolibarr.digiai.displayResults(n)}catch(i){alert(i.message),$("#digiai_modal").removeClass("modal-active")}},window.digiriskdolibarr.digiai.displayResults=function(i){$(".modal-analyse-phase").fadeOut(400,function(){$(".modal-result-phase").fadeIn(400)});var e=$("#risque_table");e.css("display","table");let r=e.find("tbody"),o=(r.empty(),$("#dol_url_root").val()),d=window.digiriskdolibarr.categoryMap;i.forEach((i,e)=>{var e=$('<tr class="oddeven" id="new_risk'+e+'">'),s=i.title,t=(e.attr("data-category",s),parseInt(i.cotation)),a=i.description,i=i.prevention_actions,a=window.digiriskdolibarr.risk_table_common.createDescriptionTextarea(a),t=window.digiriskdolibarr.risk_table_common.createCotationElement(t),i=window.digiriskdolibarr.risk_table_common.createActionsContainer(i),s=window.digiriskdolibarr.risk_table_common.createCategoryImage(o+"/custom/digiriskdolibarr/img/categorieDangers/"+s+".png",d[s]||"Catégorie inconnue"),n=window.digiriskdolibarr.risk_table_common.createCheckbox("select-risk","submit_selected_risks");e.append($("<td>").append(n)),e.append($("<td>").append(s)),e.append($("<td>").append(t)),e.append($("<td>").append(a)),e.append($("<td>").append(i)),r.append(e)}),window.digiriskdolibarr.digiai.handleSubmitButton()},window.digiriskdolibarr.digiai.handleSubmitButton=function(){let s=window.saturne.toolbox.getToken(),t=$("#dol_url_root").val();$("#submit_selected_risks").off("click").on("click",function(){var i=$("input.select-risk:checked").closest("tr");0!==i.length&&i.each(function(){let e=$(this);var i=window.digiriskdolibarr.risk_table_common.extractRiskDataFromRow(e);$.ajax({url:t+"/custom/digiriskdolibarr/core/ajax/create_risk.php?token="+s,method:"POST",data:JSON.stringify(i),contentType:"application/json",dataType:"json",cache:!1,headers:{"X-Requested-With":"XMLHttpRequest"},success:function(){var i=e.clone(),i=(i.find(".select-risk").remove(),i.find('textarea, input[type="text"], input[type="number"]').prop("disabled",!0),i.find(".risk-evaluation-cotation").each(function(){$(this).hasClass("selected-cotation")||$(this).hide()}),$(".risque-table .previous-risks-list").append(i),e.remove(),$("input.select-risk").length);0===i&&$("#submit_selected_risks").prop("disabled",!0).css("opacity",.6),window.saturne.loader.remove($("#submit_selected_risks")),$("#submit_selected_risks").removeClass("button-disable")},error:function(i,e,s){alert("Erreur lors de l'ajout d'un risque : "+(i.responseText||s))}})})})},window.digiriskdolibarr.digiai.resetModal=function(i){$("#digiai_modal").addClass("modal-active"),$(".modal-analyse-phase").show(),$(".modal-result-phase").hide(),"image"===i?($("#uploaded-image-preview").attr("src","").show(),$("#analyzed-text-preview").hide(),$(".digiai-loader-text").text("Analyse en cours de l'image...")):"text"===i&&($("#uploaded-image-preview").hide(),$("#analyzed-text-preview").show(),$(".digiai-loader-text").text("Analyse en cours du texte...")),$(".analysis-in-progress").show().html(`
    <p class="digiai-loader-text">Analyse en cours...</p>
    <div class="loader"></div>
  `),$("#risque_table").hide().find("tbody").empty()},window.digiriskdolibarr.digiriskelement={},window.digiriskdolibarr.digiriskelement.init=function(){window.digiriskdolibarr.digiriskelement.event()},window.digiriskdolibarr.digiriskelement.event=function(){$(document).on("click","#select_all_shared_elements_by_digiriskelement",window.digiriskdolibarr.digiriskelement.selectAllSharedElementByDigiriskElement),$(document).on("click","#select_all_shared_elements",window.digiriskdolibarr.digiriskelement.selectAllSharedElements)},window.digiriskdolibarr.digiriskelement.selectAllSharedElementByDigiriskElement=function(i){var e=$(this).attr("name");this.checked?$(this).closest(".ui-widget").find(".importsharedelement-digiriskelement-"+e).not(":disabled").each(function(){this.checked=!0}):$(this).closest(".ui-widget").find(".importsharedelement-digiriskelement-"+e).not(":disabled").each(function(){this.checked=!1})},window.digiriskdolibarr.digiriskelement.selectAllSharedElements=function(i){this.checked?$(this).closest(".ui-widget").find(":checkbox").not(":disabled").not("#select_all_shared_elements_by_digiriskelement").each(function(){this.checked=!0}):$(this).closest(".ui-widget").find(":checkbox").not(":disabled").not("#select_all_shared_elements_by_digiriskelement").each(function(){this.checked=!1})},window.digiriskdolibarr.document={},window.digiriskdolibarr.document.canvas,window.digiriskdolibarr.document.buttonSignature,window.digiriskdolibarr.document.init=function(){window.digiriskdolibarr.document.event()},window.digiriskdolibarr.document.event=function(){$(document).on("click","#builddoc_generatebutton",window.digiriskdolibarr.document.displayLoader),$(document).on("click",".pdf-generation",window.digiriskdolibarr.document.displayLoader),$(document).on("click",".send-risk-assessment-document-by-mail",window.digiriskdolibarr.document.displayLoader)},window.digiriskdolibarr.document.displayLoader=function(){window.saturne.loader.display($(this).closest(".div-table-responsive-no-min"))},window.digiriskdolibarr.evaluationMethodEvarisk={},window.digiriskdolibarr.evaluationMethodEvarisk.init=function(){window.digiriskdolibarr.evaluationMethodEvarisk.event()},window.digiriskdolibarr.evaluationMethodEvarisk.event=function(){$(document).on("click",".wpeo-table.evaluation-method .table-cell.can-select",window.digiriskdolibarr.evaluationMethodEvarisk.selectSeuil)},window.digiriskdolibarr.evaluationMethodEvarisk.selectSeuil=function(i){$(this).closest(".table-row").find(".active").removeClass("active"),$(this).addClass("active");var s=$(this),t=s.closest(".modal-container"),s=s.data("evaluation-id");let a=[];if(Object.values(t.find(".table-cell.active.cell-"+s)).forEach(function(i){-1<$(i).data("seuil")&&a.push($(i).data("seuil"))}),5===a.length){let e=a[0]*a[1]*a[2]*a[3]*a[4];s=window.location.pathname.split(/view/)[0];fetch(s+"/js/json/default.json").then(i=>i.json()).then(i=>{i=i[0].option.matrix[e];t.find(".risk-evaluation-calculated-cotation").find(".risk-evaluation-cotation").attr("data-scale",window.digiriskdolibarr.evaluation.getDynamicScale(i)),t.find(".risk-evaluation-calculated-cotation").find(".risk-evaluation-cotation span").text(i),t.find(".risk-evaluation-content").find(".risk-evaluation-seuil").val(i),window.digiriskdolibarr.risk.haveDataInInput(t)})}},window.digiriskdolibarr.evaluator={},window.digiriskdolibarr.evaluator.init=function(){window.digiriskdolibarr.evaluator.event()},window.digiriskdolibarr.evaluator.event=function(){$(document).on("click",".evaluator-create",window.digiriskdolibarr.evaluator.createEvaluator),$(document).on("change","#fk_user_employer",window.digiriskdolibarr.evaluator.selectUser)},window.digiriskdolibarr.evaluator.selectUser=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".modal-container"),t=s.find("#fk_user_employer").val();window.saturne.loader.display(s.find('input[name="evaluatorJob"]')),$.ajax({url:document.URL+"&action=getEvaluatorJob&token="+e,type:"POST",processData:!1,data:JSON.stringify({userID:t}),contentType:!1,success:function(i){s.find('input[name="evaluatorJob"]').val($(i).find('input[name="evaluatorJob"]').val()),s.find('input[name="evaluatorJob"]').removeClass("wpeo-loader")},error:function(i){}}),window.digiriskdolibarr.evaluator.haveDataInInput(s)},window.digiriskdolibarr.evaluator.haveDataInInput=function(i){i=i.parent().parent();i.hasClass("evaluator-add-modal")&&(0<i.find("#fk_user_employer").val()?i.find(".button-disable").removeClass("button-disable"):i.find(".evaluator-create").addClass("button-disable"))},window.digiriskdolibarr.evaluator.createEvaluator=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".fichecenter").find(".evaluator-content"),t=$("#select2-fk_user_employer-container").attr("title"),t=$("#fk_user_employer").find("option:contains('"+t+"')").attr("value"),a=s.find("#EvaluatorDate").val(),n=s.find(".evaluator-duration .duration").val(),s=s.find(".evaluatorJob").val(),r=$(this).closest(".fichecenter").find(".div-table-responsive");window.saturne.loader.display(r),$.ajax({url:document.URL+"&action=add&token="+e,type:"POST",data:JSON.stringify({evaluatorID:t,date:a,duration:n,job:s}),processData:!1,contentType:!1,success:function(i){$(".fichecenter").html($(i).find("#searchFormEvaluator"));var e=$(".messageSuccessEvaluatorCreate");e.find($(i).find(".evaluator-create-success-notice")),e.removeClass("hidden")},error:function(i){var e=$(".messageErrorEvaluatorCreate");e.find($(i).find(".evaluator-create-error-notice")),e.removeClass("hidden")}})},window.digiriskdolibarr.form={},window.digiriskdolibarr.form.init=function(){window.digiriskdolibarr.form.event()},window.digiriskdolibarr.form.event=function(){$(document).on("submit","#searchFormListRisks, #searchFormInheritedListRisks, #searchFormSharedListRisks, #searchFormListRiskSigns, #searchFormEvaluator",window.digiriskdolibarr.form.searchForm)},window.digiriskdolibarr.form.searchForm=function(i){i.preventDefault();let e=0,s=(void 0!==i.originalEvent&&$(i.originalEvent.submitter).hasClass("button_removefilter")&&(e=1),$(this).closest("form").attr("id")),t=document.getElementById(s),a=new FormData(t);var n=new FormData,r=["token","formfilteraction","action","id","sortfield","sortorder","page","contextpage","limit","toselect[]","massaction","confirm","cancel","pageplusone","backtopage","button_removefilter_x","button_removefilter","button_removefilter.x","risklist_selectedfields","shared_risklist_selectedfields","inherited_risklist_selectedfields"];if(e)n.append("button_removefilter_x","x"),n.append("token",a.entries().token);else for(var o of a.entries())(r.includes(o[0])||o[0].match(/search_/))&&n.append(o[0],o[1]);window.saturne.loader.display($("#"+s)),$.ajax({url:document.URL,type:"POST",data:n,processData:!1,contentType:!1,success:function(i){window.saturne.loader.remove($("#"+s)),$("#"+s).replaceWith($(i).find("#"+s))}})},window.digiriskdolibarr.navigation={},window.digiriskdolibarr.navigation.init=function(){window.digiriskdolibarr.navigation.event()},window.digiriskdolibarr.navigation.event=function(){$(document).on("click",".toggle-unit",window.digiriskdolibarr.navigation.switchToggle),$(document).on("click",".digirisk-wrap .navigation-container .toolbar div",window.digiriskdolibarr.navigation.toggleAll),$(document).on("click","#slider",window.digiriskdolibarr.navigation.setUnitActive),$(document).on("click",".side-nav-responsive",window.digiriskdolibarr.navigation.toggleMobileNav),$(document).on("click",".save-organization",window.digiriskdolibarr.navigation.saveOrganization)},window.digiriskdolibarr.navigation.switchToggle=function(i){var e,s=null==(s=localStorage.menu)||""==s?new Set:(s=JSON.parse(s),new Set(s));$(this).find(".toggle-icon").hasClass("fa-chevron-down")?($(this).find(".toggle-icon").removeClass("fa-chevron-down").addClass("fa-chevron-right"),e=$(this).closest(".unit").attr("id").split("unit")[1],$(this).closest(".unit").removeClass("toggled"),s.delete(e),localStorage.setItem("menu",JSON.stringify(Array.from(s.keys())))):$(this).find(".toggle-icon").hasClass("fa-chevron-right")&&($(this).find(".toggle-icon").removeClass("fa-chevron-right").addClass("fa-chevron-down"),$(this).closest(".unit").addClass("toggled"),e=$(this).closest(".unit").attr("id").split("unit")[1],s.add(e),localStorage.setItem("menu",JSON.stringify(Array.from(s.keys()))))},window.digiriskdolibarr.navigation.toggleAll=function(i){if(i.preventDefault(),$(this).hasClass("toggle-plus")){$(".digirisk-wrap .navigation-container .workunit-list .unit .toggle-icon").removeClass("fa-chevron-right").addClass("fa-chevron-down"),$(".digirisk-wrap .navigation-container .workunit-list .unit").addClass("toggled");let e=[];$(".digirisk-wrap .navigation-container .workunit-list .unit .title").get().map(function(i){e.push($(i).attr("value"))}),localStorage.setItem("menu",JSON.stringify(Array.from(e.values())))}$(this).hasClass("toggle-minus")&&($(".digirisk-wrap .navigation-container .workunit-list .unit.toggled").removeClass("toggled"),$(".digirisk-wrap .navigation-container .workunit-list .unit .toggle-icon").addClass("fa-chevron-right").removeClass("fa-chevron-down"),i=new Set("0"),localStorage.setItem("menu",JSON.stringify(Object.values(i))))},window.digiriskdolibarr.navigation.setUnitActive=function(i){$(".digirisk-wrap .navigation-container .unit.active").removeClass("active");var e=$(this).attr("value");$(this).closest(".unit").addClass("active"),$(this).closest(".unit").attr("value",e)},window.digiriskdolibarr.navigation.toggleMobileNav=function(i){$(this).closest(".side-nav").find("#id-left").toggleClass("active")},window.digiriskdolibarr.navigation.saveOrganization=function(i){var e=window.saturne.toolbox.getToken();let s=[],t=[],a,n,r=$(".messageSuccessOrganizationSaved"),o=$(".messageErrorOrganizationSaved");$(".route").each(function(){a=$(this).attr("id"),n=$(this).parent("ul").attr("id").split(/space/)[1],s.push(a),t.push(n)}),window.saturne.loader.display($(this)),$.ajax({url:document.URL+"&action=saveOrganization&ids="+s.toString()+"&parent_ids="+t+"&token="+e,success:function(){r.removeClass("hidden"),$(".wpeo-loader").addClass("button-disable"),$(".wpeo-loader").attr("style","background: #47e58e !important;border-color: #47e58e !important;"),$(".wpeo-loader").find(".fas.fa-check").attr("style",""),$("a").attr("onclick","").unbind("click"),$(".wpeo-loader").removeClass("wpeo-loader")},error:function(){o.removeClass("hidden"),$(".wpeo-loader").addClass("button-disable"),$(".wpeo-loader").attr("style","background: #e05353 !important;border-color: #e05353 !important;"),$(".wpeo-loader").find(".fas.fa-times").attr("style",""),$(".wpeo-loader").removeClass("wpeo-loader")}})},window.digiriskdolibarr.preventionplan={},window.digiriskdolibarr.preventionplan.init=function(){window.digiriskdolibarr.preventionplan.event()},window.digiriskdolibarr.preventionplan.event=function(){$(document).on("click","#prior_visit_bool",window.digiriskdolibarr.preventionplan.showDateAndText)},window.digiriskdolibarr.preventionplan.showDateAndText=function(){var i=$(this).closest(".preventionplan-table").find(".prior_visit_date_field"),e=$(this).closest(".preventionplan-table").find(".prior_visit_text_field");i.hasClass("hidden")?(i.attr("style",""),e.attr("style",""),i.removeClass("hidden"),e.removeClass("hidden")):(i.attr("style","display:none"),e.attr("style","display:none"),i.addClass("hidden"),e.addClass("hidden"))},window.digiriskdolibarr.psychosocialRisks={},window.digiriskdolibarr.psychosocialRisks.init=function(){window.digiriskdolibarr.psychosocialRisks.event(),setTimeout(function(){window.digiriskdolibarr.psychosocialRisks.toggleAddButton()},100)},window.digiriskdolibarr.psychosocialRisks.event=function(){$(document).on("change",".select-psychosocial-risk",window.digiriskdolibarr.psychosocialRisks.toggleAddButton),$(document).on("click","#submit_selected_psychosocial_risks",window.digiriskdolibarr.psychosocialRisks.submitSelectedRisks),$(document).on("change","#select_all_psychosocial_risks",window.digiriskdolibarr.psychosocialRisks.toggleSelectAll)},window.digiriskdolibarr.psychosocialRisks.toggleAddButton=function(){0<$(".select-psychosocial-risk:checked").length?($("#submit_selected_psychosocial_risks").removeAttr("disabled").css("opacity","1"),$("#submit_selected_psychosocial_risks").removeClass("button-grey")):($("#submit_selected_psychosocial_risks").attr("disabled","disabled").css("opacity","0.6"),$("#submit_selected_psychosocial_risks").addClass("button-grey")),window.digiriskdolibarr.psychosocialRisks.updateSelectAllState()},window.digiriskdolibarr.psychosocialRisks.toggleSelectAll=function(){var i=$(this).is(":checked");$(".select-psychosocial-risk").prop("checked",i),window.digiriskdolibarr.psychosocialRisks.toggleAddButton()},window.digiriskdolibarr.psychosocialRisks.updateSelectAllState=function(){var i=$(".select-psychosocial-risk").length,e=$(".select-psychosocial-risk:checked").length,s=$("#select_all_psychosocial_risks");e===i&&0<i?(s.prop("checked",!0),s.prop("",!1)):0===e?(s.prop("checked",!1),s.prop("",!1)):(s.prop("checked",!1),s.prop("",!0))},window.digiriskdolibarr.psychosocialRisks.collectSelectedRisksData=function(){let n=[],r=$(".psychosocial-risk-add-modal").attr("value");return $(".select-psychosocial-risk:checked").each(function(){var i=$(this).attr("name").match(/\[(\d+)\]/)[1],i=$("#psychosocial_risk_"+i),e=[],s=i.find(".task-name").val(),s=(s&&""!==s.trim()&&e.push(s.trim()),i.find(".risk-evaluation-cotation.selected-cotation").data("evaluation-id")),t=i.find(".risk-description").val(),a=i.find(".sub-category").val(),i=i.find(".riskassessment-date").val()||"";n.push({description:t,cotation:s,method:"standard",fk_element:r,riskassessment_date:i,category:17,sub_category:a,photo:"",tasks:e,dateStart:"",hourStart:"",minStart:"",dateEnd:"",hourEnd:"",minEnd:"",budget:""})}),n},window.digiriskdolibarr.psychosocialRisks.submitSelectedRisks=function(i){i.preventDefault();var i=$(this),e=i.find("span").html(),s=(i.attr("disabled","disabled").css("opacity","0.6"),i.find("span").html('<i class="fas fa-spinner fa-spin"></i> Ajout en cours...'),window.digiriskdolibarr.psychosocialRisks.collectSelectedRisksData());0===s.length?(i.removeAttr("disabled").css("opacity","1"),i.find("span").html(e)):(console.log("Données envoyées:",s),window.digiriskdolibarr.risk_table_common.submitRisks(s,function(i,e){},function(i,e,s,t){}))},window.digiriskdolibarr.risk={},window.digiriskdolibarr.risk.init=function(){window.digiriskdolibarr.risk.event()},window.digiriskdolibarr.risk.event=function(){$(document).on("click",".category-danger .item, .wpeo-table .category-danger .item",window.digiriskdolibarr.risk.selectDanger),$(document).on("click",".risk-create:not(.button-disable)",window.digiriskdolibarr.risk.createRisk),$(document).on("click",".risk-save",window.digiriskdolibarr.risk.saveRisk),$(document).on("click",".risk-unlink-shared",window.digiriskdolibarr.risk.unlinkSharedRisk),$(document).on("click",'div[aria-describedby="dialog-confirm-actionButtonImportSharedRisks"] .ui-button.ui-corner-all.ui-widget',window.digiriskdolibarr.risk.sharedRiskBoxLoader),$(document).on("input",".evaluation-comment-textarea",window.digiriskdolibarr.risk.evaluationCommentChange)},window.digiriskdolibarr.risk.selectDanger=function(i){var e=$(this);e.closest(".content").removeClass("active"),e.closest(".wpeo-dropdown").find(".dropdown-toggle span").hide(),e.closest(".wpeo-dropdown").find(".dropdown-toggle img").show(),e.closest(".wpeo-dropdown").find(".dropdown-toggle img").attr("src",e.find("img").attr("src")),e.closest(".wpeo-dropdown").find(".dropdown-toggle img").attr("aria-label",e.closest(".wpeo-tooltip-event").attr("aria-label")),e.closest(".wpeo-dropdown").find(".input-hidden-danger").val(e.data("id"));1==e.closest(".wpeo-dropdown").find(".input-risk-description-prefill").val()&&e.closest(".risk-content").find(".risk-description textarea").text(e.closest(".wpeo-tooltip-event").attr("aria-label"));e=$(this).closest(".modal-container");window.digiriskdolibarr.risk.haveDataInInput(e)},window.digiriskdolibarr.risk.haveDataInInput=function(i){var i=i.parent().parent(),e=i.find(".risk-evaluation-seuil");i.hasClass("risk-add-modal")?0<=i.find('input[name="risk_category_id"]').val()&&0<=e.val()&&i.find(".risk-create.button-disable").removeClass("button-disable"):i.hasClass("risk-evaluation-add-modal")&&0<=e.val()&&i.find(".risk-evaluation-create.button-disable").removeClass("button-disable")},window.digiriskdolibarr.risk.sanitizeBeforeRequest=function(i){return"string"==typeof i&&i.match(/"/)?i.split(/"/).join(""):i},window.digiriskdolibarr.risk.createRisk=function(i){var e=window.saturne.toolbox.getToken(),s=$(".risk-add-modal"),t=s.closest(".fichecenter").find(".risk-content"),a=s.closest(".fichecenter").find(".risk-evaluation-container"),n=s.closest(".fichecenter").find(".riskassessment-task"),r=t.find(".risk-description textarea").val(),o=a.find(".risk-evaluation-comment textarea").val(),d=n.find("input").val(),r=window.digiriskdolibarr.risk.sanitizeBeforeRequest(r),o=window.digiriskdolibarr.risk.sanitizeBeforeRequest(o),d=window.digiriskdolibarr.risk.sanitizeBeforeRequest(d),t=t.find(".risk-category input").val(),l=a.find(".risk-evaluation-header .risk-evaluation-method").val(),c=a.find(".risk-evaluation-seuil").val(),s=s.find(".photo .media-container .media-gallery-favorite.favorite .filename").val(),a=a.find("#RiskAssessmentDate").val(),k=[],u=(Object.values($(".table-cell.active.cell-0")).forEach(function(i){-1<$(i).data("seuil")&&(k[$(i).data("type")]=$(i).data("seuil"))}),[]),m=($(this).closest(".modal-container").find(".risk-categories").find(":selected").each(function(){u.push($(this).val())}),n.find("#RiskassessmentTaskDateStartModalRisk").val()),w=n.find("#RiskassessmentTaskDateStartModalRiskhour").val(),v=n.find("#RiskassessmentTaskDateStartModalRiskmin").val(),g=n.find("#RiskassessmentTaskDateEndModalRisk").val(),f=n.find("#RiskassessmentTaskDateEndModalRiskhour").val(),p=n.find("#RiskassessmentTaskDateEndModalRiskmin").val(),n=n.find(".riskassessment-task-budget").val();window.saturne.loader.display($(".fichecenter.risklist")),$.ajax({url:document.URL+"&action=add&token="+e,type:"POST",data:JSON.stringify({cotation:c,comment:o,category:t,description:r,method:l,photo:s,date:a,task:d,dateStart:m,hourStart:w,minStart:v,dateEnd:g,hourEnd:f,minEnd:p,budget:n,categories:u,criteres:{gravite:k.gravite||0,occurrence:k.occurrence||0,protection:k.protection||0,formation:k.formation||0,exposition:k.exposition||0}}),processData:!1,contentType:!1,success:function(i){$(".fichecenter.risklist").html($(i).find("#searchFormListRisks"));var e=$(".messageSuccessRiskCreate");e.html($(i).find(".risk-create-success-notice")),e.removeClass("hidden"),$(".fichecenter.risklist").removeClass("wpeo-loader")},error:function(i){var e=$(".messageErrorRiskCreate");e.html($(i).find(".risk-create-error-notice")),e.removeClass("hidden"),$(".fichecenter.risklist").removeClass("wpeo-loader")}})},window.digiriskdolibarr.risk.saveRisk=function(i){var e=window.saturne.toolbox.getToken();let t=$(this).attr("value");var s=$(this).closest(".risk-container").find(".risk-content"),a=new window.URLSearchParams(window.location.search).get("id");let n=$(this).closest(".risk-container").find(".move-risk").hasClass("move-disabled");var r=s.find(".risk-description textarea").val(),r=window.digiriskdolibarr.risk.sanitizeBeforeRequest(r),s=s.find(".risk-category input").val(),o=(r=r||"",$(this).closest(".risk-container").find("#socid option:selected").val());o==a||n?(window.saturne.loader.display($(this).closest(".risk-row-content-"+t).find(".risk-description-"+t)),window.saturne.loader.display($(this).closest(".risk-row-content-"+t).find(".risk-category"))):window.saturne.loader.display($(this).closest(".risk-row-content-"+t));let d=$(".risk_row_"+t).find(".risk-container > div:nth-child(1)").text();var l=[];$(this).closest(".modal-container").find(".risk-categories").find(":selected").each(function(){l.push($(this).val())}),$.ajax({url:document.URL+"&action=saveRisk&token="+e,type:"POST",processData:!1,data:JSON.stringify({riskID:t,category:s,comment:r,newParent:o,categories:l}),contentType:!1,success:function(i){$(".wpeo-loader").removeClass("wpeo-loader");var e=$(".messageSuccessRiskEdit"),s=(o==a||n?($(".modal-active").removeClass("modal-active"),$(".risk-description-"+t).html($(i).find(".risk-description-"+t)),$(".risk-row-content-"+t).find(".risk-category .cell-risk").html($(i).find(".risk-row-content-"+t).find(".risk-category .cell-risk").children()),$(".risk-row-content-"+t).find(".risk-category").fadeOut(800),$(".risk-row-content-"+t).find(".risk-category").fadeIn(800),$(".risk-row-content-"+t).find(".risk-description-"+t).fadeOut(800),$(".risk-row-content-"+t).find(".risk-description-"+t).fadeIn(800)):$(".risk-row-content-"+t).fadeOut(800,function(){$(".risklist").replaceWith($(i).find(".risklist"))}),""),s=(s=(s+=e.find(".valueForEditRisk1").val())+d)+e.find(".valueForEditRisk2").val();e.find("a").attr("href","#risk_row_"+t),e.find(".notice-subtitle .text").text(s),e.removeClass("hidden")},error:function(i){var e=$(".messageErrorRiskEdit"),s="",s=(s=(s+=e.find(".valueForEditRisk1").val())+d)+e.find(".valueForEditRisk2").val();e.find(".notice-subtitle .text").text(s),e.removeClass("hidden")}})},window.digiriskdolibarr.risk.unlinkSharedRisk=function(i){var e=window.saturne.toolbox.getToken();let s=$(this).attr("value"),t=(window.saturne.loader.display($(this)),$(".risk_row_"+s).find(".risk-container > div:nth-child(1)").text());var a=document.URL.split(/#/);$.ajax({url:a[0]+"&action=unlinkSharedRisk&token="+e,type:"POST",processData:!1,data:JSON.stringify({riskID:s}),contentType:!1,success:function(i){$(".confirmquestions").html($(i).find(".confirmquestions").children()),$(".fichecenter.sharedrisklist .opacitymedium.colorblack.paddingleft").html($(i).find("#searchFormSharedListRisks .opacitymedium.colorblack.paddingleft"));var i=$(".messageSuccessRiskUnlinkShared"),e=($("#risk_row_"+s).fadeOut(800),""),e=(e=(e+=i.find(".valueForUnlinkSharedRisk1").val())+t)+i.find(".valueForUnlinkSharedRisk2").val();i.find(".notice-subtitle .text").text(e),i.removeClass("hidden")},error:function(i){var e=$(".messageErrorRiskUnlinkShared"),s="",s=(s=(s+=e.find(".valueForUnlinkSharedRisk1").val())+t)+e.find(".valueForUnlinkSharedRisk2").val();e.find(".notice-subtitle .text").text(s),e.removeClass("hidden")}})},window.digiriskdolibarr.risk.sharedRiskBoxLoader=function(i){"Oui"==$(this).text()&&window.saturne.loader.display($("#searchFormSharedListRisks"))},window.digiriskdolibarr.risk.evaluationCommentChange=function(i){var e=$(this),s=e.data("maxlength")||65535,t=s-e.val().length,e=e.closest(".risk-evaluation-comment").find(".title");e.find(".char-counter").text(t),t<.2*s?e.find(".char-counter").addClass("text-warning"):e.find(".char-counter").removeClass("text-warning")},window.digiriskdolibarr.evaluation={},window.digiriskdolibarr.evaluation.init=function(){window.digiriskdolibarr.evaluation.event()},window.digiriskdolibarr.evaluation.event=function(){$(document).on("click",".select-evaluation-method",window.digiriskdolibarr.evaluation.selectEvaluationMethod),$(document).on("click",".cotation-container .risk-evaluation-cotation.cotation",window.digiriskdolibarr.evaluation.selectSeuil),$(document).on("click",".risk-evaluation-create",window.digiriskdolibarr.evaluation.createEvaluation),$(document).on("click",".risk-evaluation-save",window.digiriskdolibarr.evaluation.saveEvaluation),$(document).on("click",".risk-evaluation-delete",window.digiriskdolibarr.evaluation.deleteEvaluation)},window.digiriskdolibarr.evaluation.selectEvaluationMethod=function(i){var e=$(this).closest(".modal-container");0<e.find(".risk-evaluation-multiple-method").val()&&(e.find(".select-evaluation-method.selected").removeClass("selected"),$(this).addClass("selected"),$(this).removeClass("button-grey"),$(this).addClass("button-blue"),e.find(".select-evaluation-method:not(.selected)").removeClass("button-blue"),e.find(".select-evaluation-method:not(.selected)").addClass("button-grey"),$(this).hasClass("evaluation-standard")?(e.find(".cotation-advanced").attr("style","display:none"),e.find(".cotation-standard").attr("style","display:block"),e.find(".risk-evaluation-calculated-cotation").attr("style","display:none"),e.find(".risk-evaluation-method").val("standard"),e.find(this).closest(".risk-evaluation-container").removeClass("advanced"),e.find(this).closest(".risk-evaluation-container").addClass("standard")):(e.find(".cotation-standard").attr("style","display:none"),e.find(".cotation-advanced").attr("style","display:block"),e.find(".risk-evaluation-calculated-cotation").attr("style","display:block"),e.find(".risk-evaluation-method").val("advanced"),e.find(this).closest(".risk-evaluation-container").addClass("advanced"),e.find(this).closest(".risk-evaluation-container").removeClass("standard")))},window.digiriskdolibarr.evaluation.selectSeuil=function(i){var e=$(this),s=$(this).closest(".modal-container"),t=e.data("seuil"),a=e.data("variable-id"),n=e.data("evaluation-id");e.closest(".cotation-container").find(".risk-evaluation-seuil").val(n),e.closest(".cotation-container").find(".selected-cotation").removeClass("selected-cotation"),e.addClass("selected-cotation"),a&&t&&window.digiriskdolibarr.risk.haveDataInInput(s)},window.digiriskdolibarr.evaluation.getDynamicScale=function(i){switch(!0){case 0===i:case i<48:return 1;case i<51:return 2;case i<79:return 3;case i<101:return 4}},window.digiriskdolibarr.evaluation.createEvaluation=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".risk-evaluation-add-modal"),t=s.find(".modal-risk").attr("value"),a=s.find(".risk-evaluation-container"),n=a.find(".risk-evaluation-comment textarea").val(),n=window.digiriskdolibarr.risk.sanitizeBeforeRequest(n),r=a.find(".risk-evaluation-method").val(),o=a.find(".risk-evaluation-seuil").val(),d=a.find("#RiskAssessmentDateCreate0").val(),a=a.find(".photo .media-container .file-name").val();let l=[];Object.values($(".table-cell.active.cell-0")).forEach(function(i){-1<$(i).data("seuil")&&(l[$(i).data("type")]=$(i).data("seuil"))}),console.log(s),console.log(s.find(".modal-risk.modal-active")),window.saturne.loader.display($(this)),window.saturne.loader.display($(".risk-evaluation-list-container-"+t)),$.ajax({url:document.URL+"&action=addEvaluation&token="+e,type:"POST",data:JSON.stringify({cotation:o,comment:n,method:r,photo:a,date:d,riskId:t,criteres:{gravite:l.gravite||0,occurrence:l.occurrence||l.historique||0,protection:l.protection||l.milieu||0,formation:l.formation||l.maitrise||0,exposition:l.exposition||l.frequence||0}}),processData:!1,contentType:!1,success:function(i){0<$(i).find(".risk-evaluation-list-container-"+t).length?$(".risk-evaluation-list-container-"+t).replaceWith($(i).find(".risk-evaluation-list-container-"+t)):$(".div-table-responsive").replaceWith($(i).find(".div-table-responsive"));var e=$(".messageSuccessEvaluationCreate");$(".risk-evaluation-list-container-"+t).fadeOut(800),$(".risk-evaluation-list-container-"+t).fadeIn(800),e.empty(),e.html($(i).find(".riskassessment-create-success-notice")),e.find("a").attr("href","#risk_row_"+t),$(".wpeo-loader").removeClass("wpeo-loader"),e.removeClass("hidden")},error:function(i){var e=$(".messageErrorEvaluationCreate");$(this).closest(".risk-row-content-"+t).removeClass("wpeo-loader"),e.empty(),e.html($(i).find(".riskassessment-create-error-notice")),e.removeClass("hidden")}})},window.digiriskdolibarr.evaluation.deleteEvaluation=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".risk-evaluation-in-modal"),t=s.find(".labelForDelete").val();let r=$(".messageSuccessEvaluationDelete"),o=$(".messageErrorEvaluationDelete"),d=s.attr("value"),a=confirm(t);if(1!=a)return!1;{let t=$(this).closest(".risk-evaluations-list-content"),a=t.attr("value"),n=$(".risk-evaluation-ref-"+d).attr("value");window.saturne.loader.display($(".risk-evaluation-ref-"+d)),$.ajax({url:document.URL+"&action=deleteEvaluation&deletedEvaluationId="+d+"&token="+e,type:"POST",processData:!1,contentType:!1,success:function(i){$(".risk-evaluation-container-"+d).fadeOut(400),$(".risk-evaluation-list-content-"+a).replaceWith($(i).find(".risk-evaluation-list-content-"+a)),$("#risk_evaluation_add"+a).replaceWith($(i).find("#risk_evaluation_add"+a));var e=$("#risk_row_"+a).find(".table-cell-header-label").text(),s=e.split(/\(/)[1].split(/\)/)[0],e=($("#risk_row_"+a).find(".table-cell-header-label").html("<strong>"+e.split(/\(/)[0]+"("+(+s-1)+")</strong>"),s-1<1&&$(".fichecenter.risklist").html($(i).find("#searchFormListRisks")),t.removeClass("wpeo-loader"),""),e=(e=(e+=r.find(".valueForDeleteEvaluation1").val())+n)+r.find(".valueForDeleteEvaluation2").val();r.find(".notice-subtitle .text").text(e),r.removeClass("hidden")},error:function(i){var e="",e=(e=(e+=o.find(".valueForDeleteEvaluation1").val())+n)+o.find(".valueForDeleteEvaluation2").val();o.find(".notice-subtitle .text").text(e),o.removeClass("hidden")}})}},window.digiriskdolibarr.evaluation.saveEvaluation=function(i){var e=window.saturne.toolbox.getToken();let s=$(this).closest(".risk-evaluation-edit-modal"),t=s.attr("value");var a=s.find(".risk-evaluation-comment textarea").val();let n=$(this).closest(".risk-row").find(".risk-evaluations-list-content").attr("value"),r=$(".risk-evaluation-ref-"+t).attr("value"),o=$(".risk-evaluation-list-modal-"+n),d=$("#risk_evaluation_list"+n).hasClass("modal-active");var a=window.digiriskdolibarr.risk.sanitizeBeforeRequest(a),l=s.find(".risk-evaluation-method").val(),c=s.find(".risk-evaluation-seuil").val(),k=s.find("#RiskAssessmentDateEdit"+t).val(),u=s.find(".risk-evaluation-photo .filename").val();let m=[];Object.values($(".table-cell.active.cell-"+t)).forEach(function(i){-1<$(i).data("seuil")&&(m[$(i).data("type")]=$(i).data("seuil"))}),window.saturne.loader.display($(this)),$.ajax({url:document.URL+"&action=saveEvaluation&token="+e,type:"POST",processData:!1,data:JSON.stringify({cotation:c,comment:a,method:l,photo:u,date:k,evaluationID:t,criteres:{gravite:m.gravite||0,occurrence:m.occurrence||m.historique||0,protection:m.protection||m.milieu||0,formation:m.formation||m.maitrise||0,exposition:m.exposition||m.frequence||0}}),contentType:!1,success:function(i){$("#risk_evaluation_edit"+t).removeClass("modal-active"),0<$(i).find(".risk-evaluation-container.risk-evaluation-container-"+t+":not(.last-risk-assessment)").length?((d?($(".risk-evaluation-ref-"+t+":not(.last-risk-assessment)").fadeOut(800),$(".risk-evaluation-ref-"+t+":not(.last-risk-assessment)")):($(".risk-evaluation-container-"+t+":not(.last-risk-assessment)").fadeOut(800),$(".risk-evaluation-container-"+t+":not(.last-risk-assessment)"))).fadeIn(800),o.find(".risk-evaluation-ref-"+t).replaceWith($(i).find(".risk-evaluation-ref-"+t)),$(".risk-evaluation-container.risk-evaluation-container-"+t+":not(.last-risk-assessment)").replaceWith($(i).find(".risk-evaluation-container.risk-evaluation-container-"+t+":not(.last-risk-assessment)")),$("#risk_evaluation_add"+n).html($(i).find("#risk_evaluation_add"+n).children())):($(".div-table-responsive").html($(i).find(".div-table-responsive").children()),(d?($(".risk-evaluation-ref-"+t+":not(.last-risk-assessment)").fadeOut(800),$(".risk-evaluation-ref-"+t+":not(.last-risk-assessment)")):($(".risk-evaluation-container-"+t+":not(.last-risk-assessment)").fadeOut(800),$(".risk-evaluation-container-"+t+":not(.last-risk-assessment)"))).fadeIn(800)),$(".wpeo-loader").removeClass("wpeo-loader");var i=$(".messageSuccessEvaluationEdit"),e=(s.find("#risk_evaluation_edit"+t).removeClass("modal-active"),""),e=(e=(e+=i.find(".valueForEditEvaluation1").val())+r)+i.find(".valueForEditEvaluation2").val();i.find("a").attr("href","#risk_row_"+n),i.find(".notice-subtitle .text").text(e),i.removeClass("hidden")},error:function(){var i=$(".messageErrorEvaluationEdit"),e="",e=(e=(e+=i.find(".valueForEditEvaluation1").val())+r)+i.find(".valueForEditEvaluation2").val();i.find(".notice-subtitle .text").text(e),i.removeClass("hidden")}})},window.digiriskdolibarr.risksign={},window.digiriskdolibarr.risksign.init=function(){window.digiriskdolibarr.risksign.event()},window.digiriskdolibarr.risksign.event=function(){$(document).on("click",".risksign-category-danger .item, .wpeo-table .risksign-category-danger .item",window.digiriskdolibarr.risksign.selectRiskSign),$(document).on("click",".risksign-create:not(.button-disable)",window.digiriskdolibarr.risksign.createRiskSign),$(document).on("click",".risksign-save",window.digiriskdolibarr.risksign.saveRiskSign),$(document).on("click",".risksign-unlink-shared",window.digiriskdolibarr.risksign.unlinkSharedRiskSign)},window.digiriskdolibarr.risksign.selectRiskSign=function(i){var e=$(this),e=(e.closest(".content").removeClass("active"),e.closest(".wpeo-dropdown").find(".dropdown-toggle span").hide(),e.closest(".wpeo-dropdown").find(".dropdown-toggle img").show(),e.closest(".wpeo-dropdown").find(".dropdown-toggle img").attr("src",e.find("img").attr("src")),e.closest(".wpeo-dropdown").find(".dropdown-toggle img").attr("aria-label",e.closest(".wpeo-tooltip-event").attr("aria-label")),e.closest(".fichecenter").find(".input-hidden-danger").val(e.data("id")),$(this).closest(".modal-container"));window.digiriskdolibarr.risksign.haveDataInInput(e)},window.digiriskdolibarr.risksign.haveDataInInput=function(i){i=i.parent().parent();i.hasClass("risksign-add-modal")&&0<=i.find('input[name="risksign_category_id"]').val()&&i.find(".button-disable").removeClass("button-disable")},window.digiriskdolibarr.risksign.createRiskSign=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".fichecenter").find(".risksign-content"),t=s.find(".risksign-category input").val(),s=s.find(".risksign-description textarea").val();window.saturne.loader.display($(".fichecenter.risksignlist")),$.ajax({url:document.URL+"&action=add&token="+e,type:"POST",data:JSON.stringify({riskSignCategory:t,riskSignDescription:s}),processData:!1,contentType:!1,success:function(i){$(".fichecenter.risksignlist").html($(i).find("#searchFormListRiskSigns"));var e=$(".messageSuccessRiskSignCreate");$(".fichecenter.risksignlist").removeClass("wpeo-loader"),e.html($(i).find(".risksign-create-success-notice")),e.removeClass("hidden")},error:function(i){var e=$(".messageErrorRiskCreate");e.html($(i).find(".risksign-create-error-notice")),e.removeClass("hidden")}})},window.digiriskdolibarr.risksign.saveRiskSign=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).attr("value");let t=$(this).closest(".risksign-container").find(".risksign-content"),a="",n=t.find(".risksign-category input").val(),r=t.find(".risksign-description textarea").val(),o=$(".risksign_row_"+s).find(".risksign-container > div:nth-child(1)").text();window.saturne.loader.display(t),$.ajax({url:document.URL+"&action=saveRiskSign&token="+e,data:JSON.stringify({riskSignID:s,riskSignCategory:n,riskSignDescription:r}),type:"POST",processData:!1,contentType:!1,success:function(i){$(".fichecenter.risksignlist").html($(i).find("#searchFormListRiskSigns"));i=$(".messageSuccessRiskSignEdit");t.removeClass("wpeo-loader"),a=(a=(a+=i.find(".valueForEditRiskSign1").val())+o)+i.find(".valueForEditRiskSign2").val(),i.find(".notice-subtitle .text").text(a),i.removeClass("hidden")},error:function(){var i=$(".messageErrorRiskSignEdit");t.removeClass("wpeo-loader"),a=(a=(a+=i.find(".valueForEditRiskSign1").val())+o)+i.find(".valueForEditRiskSign2").val(),i.find(".notice-subtitle .text").text(a),i.removeClass("hidden")}})},window.digiriskdolibarr.risksign.unlinkSharedRiskSign=function(i){var e=window.saturne.toolbox.getToken();let s=$(this).attr("value"),t=(window.saturne.loader.display($(this)),$(".risksign_row_"+s).find(".risksign-container > div:nth-child(1)").text());var a=document.URL.split(/#/);$.ajax({url:a[0]+"&action=unlinkSharedRiskSign&token="+e,type:"POST",processData:!1,data:JSON.stringify({risksignID:s}),contentType:!1,success:function(i){$(".fichecenter.sharedrisksignlist .opacitymedium.colorblack.paddingleft").html($(i).find("#searchFormSharedListRiskSigns .opacitymedium.colorblack.paddingleft"));var i=$(".messageSuccessRiskSignUnlinkShared"),e=($("#risksign_row_"+s).fadeOut(800),""),e=(e=(e+=i.find(".valueForUnlinkSharedRiskSign1").val())+t)+i.find(".valueForUnlinkSharedRiskSign2").val();i.find(".notice-subtitle .text").text(e),i.removeClass("hidden")},error:function(i){var e=$(".messageErrorRiskSignUnlinkShared"),s="",s=(s=(s+=e.find(".valueForUnlinkSharedRiskSign1").val())+t)+e.find(".valueForUnlinkSharedRiskSign2").val();e.find(".notice-subtitle .text").text(s),e.removeClass("hidden")}})},window.digiriskdolibarr.risk_table_common={},window.digiriskdolibarr.risk_table_common.createCotationElement=function(i){let s=i<=47?1:i<=50?2:i<=80?3:4;var e=$(`
    <div class="cotation-container">
      <div class="cotation-standard" style="display: block">
        <span class="title"><i class="fas fa-chart-line"></i> Cotation <required>*</required></span>
        <div class="cotation-listing wpeo-gridlayout grid-4 grid-gap-0"></div>
      </div>
    </div>
  `);let t=e.find(".cotation-listing"),a=$('<input type="hidden" name="cotation[]" value="'+i+'">');return e.append(a),Object.entries({1:{value:0,label:"0-47"},2:{value:48,label:"48-50"},3:{value:51,label:"51-80"},4:{value:100,label:"81-100"}}).forEach(([i,e])=>{e=$(`
      <div class="risk-evaluation-cotation cotation" data-evaluation-method="standard"
           data-evaluation-id="${e.value}" data-scale="${i}" data-id="0"
           data-variable-id="${152+e.value}">
        ${e.label}
      </div>
    `);e.css("cursor","pointer"),parseInt(i)===s&&e.addClass("selected-cotation"),e.on("click",function(){t.find(".selected-cotation").removeClass("selected-cotation"),$(this).addClass("selected-cotation"),a.val($(this).data("evaluation-id"))}),t.append(e)}),e},window.digiriskdolibarr.risk_table_common.createCheckbox=function(e,s){var i=$('<input type="checkbox" class="'+e+'">');return i.on("change",function(){var i=0<$("."+e+":checked").length;$("#"+s).prop("disabled",!i),$("#"+s).css("opacity",i?1:.6)}),i},window.digiriskdolibarr.risk_table_common.createActionsContainer=function(i){let e=$("<div>");return i.forEach(i=>{i=$("<textarea>").addClass("form-control action-textarea").val(i).css({width:"100%",height:"32px",resize:"vertical",overflow:"hidden",lineHeight:"1.4",padding:"6px 8px",fontSize:"13px",marginBottom:"5px"});e.append(i)}),e},window.digiriskdolibarr.risk_table_common.createCategoryImage=function(i,e){var s=$('<div class="risk-category-display">'),i=$("<img>").addClass("danger-category-pic tooltip wpeo-tooltip-event hover").attr("src",i).attr("aria-label",e).css({width:"40px",height:"40px"});return s.append(i),s},window.digiriskdolibarr.risk_table_common.createDescriptionTextarea=function(i){return $("<textarea>").addClass("form-control").val(i).css({width:"100%",height:"60px"})},window.digiriskdolibarr.risk_table_common.submitRisks=function(i,e,a){let s=window.saturne.toolbox.getToken(),n=$("#dol_url_root").val()||window.location.origin,r=0,o=0,d=i.length;i.forEach((i,t)=>{$.ajax({url:n+"/custom/digiriskdolibarr/core/ajax/create_risk.php?token="+s,method:"POST",data:JSON.stringify(i),contentType:"application/json",dataType:"json",cache:!1,headers:{"X-Requested-With":"XMLHttpRequest"},success:function(i){r++,"function"==typeof e&&e(i,t),r+o===d&&(0===o?window.location.reload():alert("Certains risques n'ont pas pu être ajoutés. Veuillez vérifier."))},error:function(i,e,s){o++,"function"==typeof a&&a(i,e,s,t),r+o===d&&(0<r?window.location.reload():alert("Aucun risque n'a pu être ajouté. Veuillez vérifier."))}})})},window.digiriskdolibarr.risk_table_common.extractRiskDataFromRow=function(i){var e=i.find("textarea").first().val(),s=parseInt(i.find('input[name="cotation[]"]').val());let t=[];i.find("textarea.action-textarea").each(function(){var i=$(this).val().trim();""!==i&&t.push(i)});i=i.data("category");return{description:e,cotation:s,method:"simple",fk_element:$(".digiai-risk-add").attr("value")||$("#digiriskElementId").val(),category:i,photo:"",tasks:t,dateStart:"",hourStart:"",minStart:"",dateEnd:"",hourEnd:"",minEnd:"",budget:""}},window.digiriskdolibarr.riskassessmenttask={},window.digiriskdolibarr.riskassessmenttask.init=function(){window.digiriskdolibarr.riskassessmenttask.event()},window.digiriskdolibarr.riskassessmenttask.event=function(){$(document).on("input",".riskassessment-task-label",window.digiriskdolibarr.riskassessmenttask.fillRiskAssessmentTaskLabel),$(document).on("click",".riskassessment-task-create",window.digiriskdolibarr.riskassessmenttask.createRiskAssessmentTask),$(document).on("click",".riskassessment-task-save",window.digiriskdolibarr.riskassessmenttask.saveRiskAssessmentTask),$(document).on("click",".riskassessment-task-delete",window.digiriskdolibarr.riskassessmenttask.deleteRiskAssessmentTask),$(document).on("click",".riskassessment-task-timespent-create",window.digiriskdolibarr.riskassessmenttask.createRiskAssessmentTaskTimeSpent),$(document).on("click",".riskassessment-task-timespent-save",window.digiriskdolibarr.riskassessmenttask.saveRiskAssessmentTaskTimeSpent),$(document).on("click",".riskassessment-task-timespent-delete",window.digiriskdolibarr.riskassessmenttask.deleteRiskAssessmentTaskTimeSpent),$(document).on("click",".riskassessment-task-progress-checkbox:not(.riskassessment-task-progress-checkbox-readonly)",window.digiriskdolibarr.riskassessmenttask.checkTaskProgress),$(document).on("change","#RiskassessmentTaskTimespentDatehour",window.digiriskdolibarr.riskassessmenttask.selectRiskassessmentTaskTimespentDateHour),$(document).on("change","#RiskassessmentTaskTimespentDatemin",window.digiriskdolibarr.riskassessmenttask.selectRiskassessmentTaskTimespentDateMin),$(document).on("keyup",".riskassessment-task-label",window.digiriskdolibarr.riskassessmenttask.checkRiskassessmentTaskLabelLength),$(document).on("click",".listingHeaderTaskTooltip",window.digiriskdolibarr.riskassessmenttask.redirectOnSharedTaskConfig)},window.digiriskdolibarr.riskassessmenttask.fillRiskAssessmentTaskLabel=function(i){var e=$(this).closest(".modal-container");window.digiriskdolibarr.riskassessmenttask.haveDataInInput(e)},window.digiriskdolibarr.riskassessmenttask.haveDataInInput=function(i){i=i.parent().parent();i.hasClass("riskassessment-task-add-modal")&&i.find('input[name="label"]').val().length&&i.find(".button-disable").removeClass("button-disable")},window.digiriskdolibarr.riskassessmenttask.createRiskAssessmentTask=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".riskassessment-task-add-modal"),t=s.find(".modal-risk").attr("value"),s=s.find(".riskassessment-task-container"),a=s.find(".riskassessment-task-label").val(),a=window.digiriskdolibarr.risk.sanitizeBeforeRequest(a),n=s.find("#RiskassessmentTaskDateStart"+t).val(),r=s.find("#RiskassessmentTaskDateStart"+t+"hour").val(),o=s.find("#RiskassessmentTaskDateStart"+t+"min").val(),d=s.find("#RiskassessmentTaskDateEnd"+t).val(),l=s.find("#RiskassessmentTaskDateEnd"+t+"hour").val(),c=s.find("#RiskassessmentTaskDateEnd"+t+"min").val(),k=s.find(".riskassessment-task-budget").val(),s=s.find(".executiveSelect").val();window.saturne.loader.display($(this)),window.saturne.loader.display($(".riskassessment-tasks"+t)),$.ajax({url:document.URL+"&action=addRiskAssessmentTask&token="+e,type:"POST",data:JSON.stringify({tasktitle:a,dateStart:n,hourStart:r,minStart:o,dateEnd:d,hourEnd:l,minEnd:c,budget:k,riskToAssign:t,executiveId:s}),processData:!1,contentType:!1,success:function(i){$(".tasks-list-container-"+t).replaceWith($(i).find(".tasks-list-container-"+t));var e=$(".messageSuccessTaskCreate");$(".riskassessment-tasks"+t).fadeOut(800),$(".riskassessment-tasks"+t).fadeIn(800),e.find("a").attr("href","#risk_row_"+t),e.html($(i).find(".task-create-success-notice")),e.removeClass("hidden")},error:function(i){$(".wpeo-loader").removeClass("wpeo-loader"),window.scrollTo(0,0);var i=JSON.parse(i.responseText),e=$(".messageErrorTaskCreate"),s=($("#risk_assessment_task_add"+t).removeClass("modal-active"),""),s=(s=(s+=e.find(".valueForCreateTask1").val())+e.find(".valueForCreateTask2").val())+" : "+i.message;e.find(".notice-subtitle .text").text(s),e.removeClass("hidden")}})},window.digiriskdolibarr.riskassessmenttask.deleteRiskAssessmentTask=function(i){var e=window.saturne.toolbox.getToken(),t=$(this).closest(".wpeo-table.riskassessment-tasks").attr("value"),a=$(this).closest(".riskassessment-task-single-content").attr("value"),s=$(this).closest(".riskassessment-task-container-"+a).find(".labelForDelete").val();let n=$(".messageSuccessTaskDelete"),r=$(".messageErrorTaskDelete"),o=confirm(s);if(1!=o)return!1;{let s=$(".riskassessment-task-container-"+a).attr("value");window.saturne.loader.display($(".riskassessment-task-container-"+a)),$.ajax({url:document.URL+"&action=deleteRiskAssessmentTask&deletedRiskAssessmentTaskId="+a+"&token="+e,type:"POST",processData:!1,contentType:!1,success:function(i){$(".riskassessment-task-listing-wrapper-"+t).replaceWith($(i).find(".riskassessment-task-listing-wrapper-"+t)),$(".riskassessment-tasks"+t).fadeOut(800),$(".riskassessment-tasks"+t).fadeIn(800);i="",i=(i=(i+=n.find(".valueForDeleteTask1").val())+s)+n.find(".valueForDeleteTask2").val();n.find("a").attr("href","#risk_row_"+t),n.find(".notice-subtitle .text").text(i),n.removeClass("hidden")},error:function(i){$(".wpeo-loader").removeClass("wpeo-loader"),window.scrollTo(0,0);var i=JSON.parse(i.responseText),e="",e=(e=(e=(e+=r.find(".valueForDeleteTask1").val())+s)+r.find(".valueForDeleteTask2").val())+" : "+i.message;r.find(".notice-subtitle .text").text(e),r.removeClass("hidden")}})}},window.digiriskdolibarr.riskassessmenttask.saveRiskAssessmentTask=function(i){var e=window.saturne.toolbox.getToken();let s=$(this).attr("value");var t=$(this).closest(".modal-container"),a=$(this).closest(".modal-risk").attr("value");let n="";var r=t.find(".riskassessment-task-label"+s).val(),r=window.digiriskdolibarr.risk.sanitizeBeforeRequest(r);let o=$(".riskassessment-task-single-"+s+" .riskassessment-task-reference").attr("value"),d=0;t.find(".riskassessment-task-progress-checkbox"+s).is(":checked")&&(d=1);var l=t.find("#RiskassessmentTaskDateStartEdit"+s).val(),c=t.find("#RiskassessmentTaskDateStartEdit"+s+"hour").val(),k=t.find("#RiskassessmentTaskDateStartEdit"+s+"min").val(),u=t.find("#RiskassessmentTaskDateEndEdit"+s).val(),m=t.find("#RiskassessmentTaskDateEndEdit"+s+"hour").val(),w=t.find("#RiskassessmentTaskDateEndEdit"+s+"min").val(),t=t.find(".riskassessment-task-budget"+s).val();window.saturne.loader.display($(this)),window.saturne.loader.display($(".riskassessment-task-single-"+s)),$.ajax({url:document.URL+"&action=saveRiskAssessmentTask&token="+e,data:JSON.stringify({riskAssessmentTaskID:s,tasktitle:r,dateStart:l,hourStart:c,minStart:k,dateEnd:u,hourEnd:m,minEnd:w,budget:t,taskProgress:d}),type:"POST",processData:!1,contentType:!1,success:function(i){$("#risk_assessment_task_edit"+s).removeClass("modal-active"),$(".riskassessment-task-container-"+s).replaceWith($(i).find(".riskassessment-task-container-"+s).first()),$("#risk_assessment_task_edit"+s+" .riskassessment-task-data .riskassessment-task-budget").replaceWith($(i).find(".riskassessment-task-container-"+s+" .riskassessment-task-budget").first()),$("#risk_assessment_task_edit"+s).replaceWith($(i).find("#risk_assessment_task_edit"+s));i=$(".messageSuccessTaskEdit");$(".riskassessment-tasks"+a).fadeOut(800),$(".riskassessment-tasks"+a).fadeIn(800),n=(n=(n+=i.find(".valueForEditTask1").val())+o)+i.find(".valueForEditTask2").val(),$(".wpeo-loader").removeClass("wpeo-loader"),$(".loader-spin").remove(),i.find("a").attr("href","#risk_row_"+a),i.find(".notice-subtitle .text").text(n),i.removeClass("hidden")},error:function(i){$(".wpeo-loader").removeClass("wpeo-loader"),window.scrollTo(0,0);var i=JSON.parse(i.responseText),e=$(".messageErrorTaskEdit");$("#risk_assessment_task_edit"+s).removeClass("modal-active"),$(".wpeo-loader").removeClass("wpeo-loader"),n=(n=(n=(n+=e.find(".valueForEditTask1").val())+o)+e.find(".valueForEditTask2").val()+" : ")+i.message,e.find(".notice-subtitle .text").text(n),e.removeClass("hidden")}})},window.digiriskdolibarr.riskassessmenttask.createRiskAssessmentTaskTimeSpent=function(i){var e=window.saturne.toolbox.getToken();let s=$(this).attr("value");var t=$(this).closest(".riskassessment-task-edit-modal"),a=t.find(".riskassessment-task-timespent-container");let n=t.find("riskassessment-task-single").attr("value"),r="",o=t.find(".riskassessment-task-reference").attr("value"),d=$(".id-container").find(".riskassessment-total-task-timespent-"+s);var t=a.find("#RiskassessmentTaskTimespentDate"+s).val(),l=a.find("#RiskassessmentTaskTimespentDate"+s+"hour").val(),c=a.find("#RiskassessmentTaskTimespentDate"+s+"min").val(),k=a.find(".riskassessment-task-timespent-comment").val(),k=window.digiriskdolibarr.risk.sanitizeBeforeRequest(k),a=a.find(".riskassessment-task-timespent-duration").val();window.saturne.loader.display($(this)),window.saturne.loader.display($(".riskassessment-task-single-"+s)),$.ajax({url:document.URL+"&action=addRiskAssessmentTaskTimeSpent&token="+e,type:"POST",data:JSON.stringify({taskID:s,date:t,hour:l,min:c,comment:k,duration:a}),processData:!1,contentType:!1,success:function(i){var e=$(".messageSuccessTaskTimeSpentCreate"+s);$(".riskassessment-tasks"+n).fadeOut(800),$(".riskassessment-tasks"+n).fadeIn(800),r=(r=(r+=e.find(".valueForCreateTaskTimeSpent1").val())+o)+e.find(".valueForCreateTaskTimeSpent2").val(),$(".riskassessment-task-timespent-container").find(".riskassessment-task-timespent-list-"+s).replaceWith($(i).find(".riskassessment-task-timespent-container").find(".riskassessment-task-timespent-list-"+s)),$(".riskassessment-task-container-"+s).closest(".riskassessment-tasks").replaceWith($(i).find(".riskassessment-task-container-"+s).closest(".riskassessment-tasks")),$(".loader-spin").remove(),$(".wpeo-loader").removeClass("wpeo-loader"),e.find(".notice-subtitle .text").text(r),e.removeClass("hidden"),d.html($(i).find(".modal-content").find(".riskassessment-total-task-timespent-"+s).first())},error:function(i){$(this).closest(".risk-row-content-"+n).removeClass("wpeo-loader");var e=$(".messageErrorTaskTimeSpentCreate"+s);e.html($(i).find(".task-timespent-create-error-notice")),e.removeClass("hidden")},complete:function(){$("#risk_assessment_task_edit"+s+".wpeo-modal").addClass("modal-active")}})},window.digiriskdolibarr.riskassessmenttask.deleteRiskAssessmentTaskTimeSpent=function(i){var e=window.saturne.toolbox.getToken();let a=$(this).closest(".riskassessment-task-timespent-list").attr("value"),n=$(this).attr("value");var s=$(this).attr("value"),t=$(this).closest(".riskassessment-task-timespent-"+n).find(".labelForDelete").val();let r=$(".id-container").first().find(".riskassessment-total-task-timespent-"+a),o=confirm(t);if(1!=o)return!1;{let t=$(".riskassessment-task-container-"+a).attr("value");window.saturne.loader.display($(this)),$.ajax({url:document.URL+"&action=deleteRiskAssessmentTaskTimeSpent&deletedRiskAssessmentTaskTimeSpentId="+s+"&token="+e,type:"POST",processData:!1,contentType:!1,success:function(i){var e=$(".messageSuccessTaskTimeSpentDelete"+a),s=($(".riskassessment-task-timespent-"+n).fadeOut(800),""),s=(s=(s+=e.find(".valueForDeleteTaskTimeSpent1").val())+t)+e.find(".valueForDeleteTaskTimeSpent2").val();e.find(".notice-subtitle .text").text(s),e.removeClass("hidden"),r.html($(i).find(".modal-content").find(".riskassessment-total-task-timespent-"+a).first())},error:function(i){var e=$(".messageErrorTaskDeleteTimeSpent"+a),s="",s=(s=(s+=e.find(".valueForDeleteTaskTimeSpent1").val())+t)+e.find(".valueForDeleteTaskTimeSpent2").val();e.find(".notice-subtitle .text").text(s),e.removeClass("hidden")}})}},window.digiriskdolibarr.riskassessmenttask.saveRiskAssessmentTaskTimeSpent=function(i){var e=window.saturne.toolbox.getToken();let s=$(this);var t=$(this).attr("value"),a=$(this).closest(".riskassessment-task-timespent-edit-modal").find(".riskassessment-task-timespent-container");let n=a.attr("value"),r="",o=$(".riskassessment-task-container-"+n).attr("value"),d=$(".id-container").first().find(".riskassessment-total-task-timespent-"+n);var l=a.find("#RiskassessmentTaskTimespentDateEdit"+t).val(),c=a.find("#RiskassessmentTaskTimespentDateEdit"+t+"hour").val(),k=a.find("#RiskassessmentTaskTimespentDateEdit"+t+"min").val(),u=a.find(".riskassessment-task-timespent-comment").val(),u=window.digiriskdolibarr.risk.sanitizeBeforeRequest(u),a=a.find(".riskassessment-task-timespent-duration").val();window.saturne.loader.display($(this)),window.saturne.loader.display($(".riskassessment-task-single-"+n)),$.ajax({url:document.URL+"&action=saveRiskAssessmentTaskTimeSpent&token="+e,data:JSON.stringify({riskAssessmentTaskTimeSpentID:t,taskID:n,date:l,hour:c,min:k,comment:u,duration:a}),type:"POST",processData:!1,contentType:!1,success:function(i){s.closest(".modal-active").removeClass("modal-active");var e=$(".messageSuccessTaskTimeSpentEdit"+n);$(".wpeo-loader").removeClass("wpeo-loader"),r=(r=(r+=e.find(".valueForEditTaskTimeSpent1").val())+o)+e.find(".valueForEditTaskTimeSpent2").val(),d.html($(i).find(".modal-content").find(".riskassessment-total-task-timespent-"+n).first()),$(".riskassessment-task-timespent-list-"+n).html($(i).find(".riskassessment-task-timespent-list-"+n).children()),e.find(".notice-subtitle .text").text(r),e.removeClass("hidden")},error:function(i){var e=$(".messageSuccessTaskTimeSpentEdit"+n);r=(r=(r+=e.find(".valueForEditTaskTimeSpent1").val())+o)+e.find(".valueForEditTaskTimeSpent2").val(),e.find(".notice-subtitle .text").text(r),e.removeClass("hidden")}})},window.digiriskdolibarr.riskassessmenttask.checkTaskProgress=function(i){var e=window.saturne.toolbox.getToken(),s=$(this).closest(".risk-row").find(".riskassessment-task-container"),t=$(this).closest(".riskassessment-task-single-content").attr("value");let a=$(this).closest(".riskassessment-tasks").attr("value"),n="",r=s.attr("value"),o="";s.find(".riskassessment-task-progress-checkbox"+t).hasClass("progress-checkbox-check")?(o=0,s.find(".riskassessment-task-progress-checkbox"+t).toggleClass("progress-checkbox-check").toggleClass("progress-checkbox-uncheck")):s.find(".riskassessment-task-progress-checkbox"+t).hasClass("progress-checkbox-uncheck")&&(o=1,s.find(".riskassessment-task-progress-checkbox"+t).toggleClass("progress-checkbox-uncheck").toggleClass("progress-checkbox-check")),window.saturne.loader.display($(".riskassessment-task-single-"+t));s=window.location.href.replace(/#.*/,"");$.ajax({url:s+"&action=checkTaskProgress&token="+e,data:JSON.stringify({riskAssessmentTaskID:t,taskProgress:o}),type:"POST",processData:!1,contentType:!1,success:function(i){$(".fichecenter.risklist").html($(i).find("#searchFormListRisks"));i=$(".messageSuccessTaskEdit");$(".riskassessment-tasks"+a).fadeOut(800),$(".riskassessment-tasks"+a).fadeIn(800),n=(n=(n+=i.find(".valueForEditTask1").val())+r)+i.find(".valueForEditTask2").val(),i.find(".notice-subtitle .text").text(n),i.removeClass("hidden")},error:function(i){var e=$(".messageErrorTaskEdit");n=(n=(n+=e.find(".valueForEditTask1").val())+r)+e.find(".valueForEditTask2").val(),e.find(".notice-subtitle .text").text(n),e.removeClass("hidden")}})},window.digiriskdolibarr.riskassessmenttask.selectRiskassessmentTaskTimespentDateHour=function(i){$(this).closest(".nowraponall").find(".select-riskassessmenttask-timespent-datehour").remove(),$(this).before('<input class="select-riskassessmenttask-timespent-datehour" type="hidden" id="RiskassessmentTaskTimespentDatehour" name="RiskassessmentTaskTimespentDatehour" value='+$(this).val()+">")},window.digiriskdolibarr.riskassessmenttask.selectRiskassessmentTaskTimespentDateMin=function(i){$(this).closest(".nowraponall").find(".select-riskassessmenttask-timespent-datemin").remove(),$(this).before('<input class="select-riskassessmenttask-timespent-datemin" type="hidden" id="RiskassessmentTaskTimespentDatemin" name="RiskassessmentTaskTimespentDatemin" value='+$(this).val()+">")},window.digiriskdolibarr.riskassessmenttask.checkRiskassessmentTaskLabelLength=function(i){255<$(this).val().length?($(".messageWarningTaskLabel").removeClass("hidden"),$(".riskassessment-task-create").removeClass("button-blue"),$(".riskassessment-task-create").addClass("button-grey"),$(".riskassessment-task-create").addClass("button-disable")):($(".messageWarningTaskLabel").addClass("hidden"),$(".riskassessment-task-create").addClass("button-blue"),$(".riskassessment-task-create").removeClass("button-grey"),$(".riskassessment-task-create").removeClass("button-disable"))},window.digiriskdolibarr.riskassessmenttask.redirectOnSharedTaskConfig=function(i){var e=$(".riskassessment-tasks").find('input[name="sharedTaskTooltipUrl"]').val();window.open(location.origin+e,"_blank")},window.digiriskdolibarr.ticket={},window.digiriskdolibarr.ticket.init=function(){window.digiriskdolibarr.ticket.event()},window.digiriskdolibarr.ticket.event=function(){$(document).on("click",".ticket-parentCategory, .ticket-subCategory",function(){$(this).parent().hasClass("category-redirect")||window.digiriskdolibarr.ticket.handleCategorySelection({clickedElement:this,isSubCategory:$(this).hasClass("ticket-subCategory")})}),$(document).on("click",".public-ticket-validate",window.digiriskdolibarr.ticket.addSignature),$(document).on("submit","#sendFile",window.digiriskdolibarr.ticket.tmpStockFile),$(document).on("click",".linked-file-delete",window.digiriskdolibarr.ticket.removeFile),$(document).on("change",".add-dashboard-info",window.digiriskdolibarr.ticket.addDashBoardTicketInfo),$(document).on("click",".close-dashboard-info",window.digiriskdolibarr.ticket.closeDashBoardTicketInfo),$(document).on("keyup","#email",window.digiriskdolibarr.ticket.checkValidEmail),$(document).on("keyup","#options_digiriskdolibarr_ticket_phone",window.digiriskdolibarr.ticket.checkValidPhone),$(document).on("change",".param-table input, .param-table select, .param-table textarea",window.digiriskdolibarr.ticket.handleParamChange),CKEDITOR.on("instanceReady",function(i){CKEDITOR.instances[i.editor.name].on("change",function(){window.digiriskdolibarr.ticket.handleParamChange.call(this.container.$)})})},window.digiriskdolibarr.ticket.handleCategorySelection=function(i){let{clickedElement:e,isSubCategory:s}=i,t=(s?$(".ticket-parentCategory.active"):$(e)).data("rowid"),a=s?$(e).data("rowid"):null;var i=window.saturne.toolbox.getToken(),n=window.saturne.toolbox.getQuerySeparator(document.URL),n=(window.saturne.loader.display($(".categories-container")),document.URL+n+"parentCategory="+t+(s?"&subCategory="+a:"")+"&token="+i);$.ajax({url:n,type:"POST",processData:!1,contentType:!1,success:function(i){$(".digirisk-page-container").replaceWith($(i).find(".digirisk-page-container")),$(".ticket-parentCategory[data-rowid="+t+"]").addClass("active"),s&&$(".ticket-subCategory[data-rowid="+a+"]").addClass("active"),window.saturne.signature.drawSignatureOnCanvas()},error:function(){console.error("Failed to retrieve category data. Please try again.")}})},window.digiriskdolibarr.ticket.addSignature=function(){var i;window.saturne.signature.canvas&&!window.saturne.signature.canvas.signaturePad.isEmpty()&&(i=window.saturne.signature.canvas.toDataURL(),$('input[name="signature"]').val(JSON.stringify(i)))},window.digiriskdolibarr.ticket.tmpStockFile=function(){event.preventDefault();var e=$("#sendfile").prop("files");let s=$("#parentCategory").val(),t=$("#subCategory").val();var a=new FormData;for(let i=0;i<e.length;i++){var n=e[i];a.append("files[]",n)}var r=$("#ticket_id").val();let o=window.saturne.toolbox.getQuerySeparator(document.URL);window.saturne.loader.display($(".files-uploaded")),fetch(document.URL+o+"action=sendfile&ticket_id="+r,{method:"POST",body:a}).then(i=>{i=$(i).find(".file-error").val();i&&$.jnotify(i,"error"),$("#sendFileForm").load(document.URL+o+"ticket_id="+r+"&parentCategory="+s+"&subCategory="+t+" #fileLinkedTable")})},window.digiriskdolibarr.ticket.removeFile=function(i){let e=$(this).attr("value");e=e.replace("_mini","");var s=$("#ticket_id").val(),t=window.saturne.toolbox.getQuerySeparator(document.URL);fetch(document.URL+t+"action=removefile&filetodelete="+e+"&ticket_id="+s,{method:"POST"}).then(i=>{$(this).parent().parent().hide()})},window.digiriskdolibarr.ticket.addDashBoardTicketInfo=function(){var i=window.saturne.toolbox.getToken(),e=$("#select2-boxcombo-container").attr("title"),s=e.split(" : ")[0],e=e.split(" : ")[2],t=window.saturne.toolbox.getQuerySeparator(document.URL);$.ajax({url:document.URL+t+"action=adddashboardinfo&token="+i,type:"POST",processData:!1,data:JSON.stringify({digiriskelementID:s,catID:e}),contentType:!1,success:function(i){window.location.reload()},error:function(){}})},window.digiriskdolibarr.ticket.closeDashBoardTicketInfo=function(){var i=window.saturne.toolbox.getToken();let e=$(this);var s=e.attr("data-digiriskelementid"),t=e.attr("data-catid"),a=window.saturne.toolbox.getQuerySeparator(document.URL);$.ajax({url:document.URL+a+"action=closedashboardinfo&token="+i,type:"POST",processData:!1,data:JSON.stringify({digiriskelementID:s,catID:t}),contentType:!1,success:function(i){e.closest(".box-flex-item").fadeOut(400),$(".add-widget-box").attr("style",""),$(".add-widget-box").html($(i).find(".add-widget-box").children())},error:function(){}})},window.digiriskdolibarr.ticket.checkValidEmail=function(){0==/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/.test(this.value)?$(this).css("border","3px solid red"):$(this).css("border","3px solid green")},window.digiriskdolibarr.ticket.checkValidPhone=function(){0==/^(?:(?:(?:\+|00)\d{2}[\s]?(?:\(0\)[\s]?)?)|0){1}[1-9]{1}([\s.-]?)(?:\d{2}\1?){3}\d{2}$/.test(this.value)?$(this).css("border","3px solid red"):$(this).css("border","3px solid green")},window.digiriskdolibarr.ticket.handleParamChange=function(){$table=$(this).closest("table"),($btn=$("."+$table.data("btn"))).prop("disabled",!1)},window.digiriskdolibarr.tools={},window.digiriskdolibarr.tools.init=function(){window.digiriskdolibarr.tools.event()},window.digiriskdolibarr.tools.event=function(){$(document).on("click","#data-migration-import-global-dolibarr",window.digiriskdolibarr.tools.submitForm)},window.digiriskdolibarr.tools.submitForm=function(s){s.preventDefault();var i=window.saturne.toolbox.getToken(),e=window.saturne.toolbox.getQuerySeparator(window.location.href),t=(window.saturne.loader.display($(s.target).parent()),$(s.target).parent().find('input[type="file"]')),a=new FormData;a.append("file",t.prop("files")[0]),$.ajax({url:window.location.href+e+"action=import_global_dolibarr&token="+i,type:"POST",data:a,contentType:!1,processData:!1,success:function(i){var e=$(i).find("input[name='error']");e.length?window.saturne.notice.showNotice("migration-dolibar-notice",e.data("title"),e.val(),"error"):(e=$(i).find("input[name='success']"),window.saturne.notice.showNotice("migration-dolibar-notice",e.data("title"),e.val(),"success")),window.saturne.loader.remove($(s.target).parent())}})},window.digiriskdolibarr.digiriskusers={},window.digiriskdolibarr.digiriskusers.init=function(){window.digiriskdolibarr.digiriskusers.event()},window.digiriskdolibarr.digiriskusers.event=function(){$(document).on("input",".digirisk-users #firstname",window.digiriskdolibarr.digiriskusers.fillEmail),$(document).on("input",".digirisk-users #lastname",window.digiriskdolibarr.digiriskusers.fillEmail)},window.digiriskdolibarr.digiriskusers.fillEmail=function(i){var e=$(".digirisk-users #firstname").val(),s=$(".digirisk-users #lastname").val(),t=$(".input-domain-mail").val(),e=window.digiriskdolibarr.digiriskusers.removeDiacritics(e+"."+s+"@"+t).toLowerCase();$(".digirisk-users #email").val(e)},window.digiriskdolibarr.digiriskusers.removeDiacritics=function(i){for(var e="",s=i.normalize("NFD"),t=0,a=0;t<i.length;)e+=s[a],a+=i[t]==s[a]?1:2,t++;return e};